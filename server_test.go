package main

import (
	"context"
	"io/ioutil"
	"net/http"
	"strings"
	"testing"
)

func TestReadServerList(t *testing.T) {
	rd := strings.NewReader(rev153List)
	list, err := readServerList(rd)
	if err != nil {
		t.Fatal(err)
	}
	t.Logf("%#v", list.Servers["vie"])
}

func TestFetchServerList(t *testing.T) {
	t.Run("local", testFetchServerListLocal)
	t.Run("remote", testFetchServerListRemote)
}

type fixedResponseRoundTripper struct {
	Resp *http.Response
}

func (rt fixedResponseRoundTripper) RoundTrip(req *http.Request) (*http.Response, error) {
	// Shallow copy. Change to deep copy in the future if necessary.
	resp := new(http.Response)
	*resp = *(rt.Resp)
	resp.Request = req
	return resp, nil
}

func testFetchServerListLocal(t *testing.T) {
	resp := &http.Response{
		StatusCode: http.StatusOK,
		Status:     http.StatusText(http.StatusOK),
		Body:       ioutil.NopCloser(strings.NewReader(rev153List)),
	}
	u := &updater{
		c: &http.Client{
			Transport: fixedResponseRoundTripper{resp},
		},
		serverListURL: defaultServerListURL,
	}
	list, err := u.fetchServerList(context.Background())
	if err != nil {
		t.Fatal(err)
	}
	t.Logf("%#v", list.Servers["vie"])
}

func testFetchServerListRemote(t *testing.T) {
	u := &updater{
		c:             &http.Client{},
		serverListURL: defaultServerListURL,
	}
	list, err := u.fetchServerList(context.Background())
	if err != nil {
		t.Fatal(err)
	}
	t.Logf("%#v", list.Servers["vie"])
}

const rev153List = `
{
  "revision": 153,
  "pops": {
    "ams": {
      "desc": "Amsterdam",
      "geo": [ 4.9, 52.37 ],
      "relay_addresses": [
        "155.133.248.34:27015-27052",
        "155.133.248.35:27015-27052",
        "155.133.248.36:27015-27052",
        "155.133.248.37:27015-27052"
      ]
    },
    "atl": {
      "desc": "Atlanta",
      "geo": [ -84.39,  33.76 ],
      "relay_addresses": [
        "162.254.199.170:27015-27052",
        "162.254.199.171:27015-27052"
      ],
      "service_address_ranges": [
        "155.133.234.0/24"
      ]
    },
    "bom": {
      "desc": "Bombay",
      "geo": [ 72.49,  18.58 ],
      "relay_addresses": [
        "155.133.233.98:27015-27052",
        "155.133.233.99:27015-27060"
      ],
      "service_address_ranges": [
        "155.133.233.0/24"
      ]
    },
    "can": {
      "geo": [ 113.15, 23.7 ],
      "partners": 2,
      "service_address_ranges": [
        "125.88.174.0/24"
      ]
    },
    "canm": {
      "partners": 2,
      "relay_addresses": [
        "183.232.225.17:27015-27068",
        "183.232.225.18:27015-27068",
        "183.232.225.19:27015-27068",
        "183.232.225.20:27015-27068",
        "183.232.225.21:27015-27068",
        "183.232.225.22:27015-27068"
      ]
    },
    "cant": {
      "partners": 2,
      "relay_addresses": [
        "125.88.174.11:27015-27068",
        "125.88.174.12:27015-27068",
        "125.88.174.13:27015-27068",
        "125.88.174.14:27015-27068",
        "125.88.174.15:27015-27068",
        "125.88.174.16:27015-27068"
      ]
    },
    "canu": {
      "partners": 2,
      "relay_addresses": [
        "157.255.37.14:27015-27068",
        "157.255.37.15:27015-27068",
        "157.255.37.16:27015-27068",
        "157.255.37.17:27015-27040",
        "157.255.37.18:27015-27068",
        "157.255.37.19:27015-27068"
      ]
    },
    "dxb": {
      "desc": "Dubai",
      "geo": [ 55.3, 25.25 ],
      "relay_addresses": [
        "185.25.183.17:27015-27052",
        "185.25.183.18:27015-27052"
      ],
      "service_address_ranges": [
        "185.25.183.0/24"
      ]
    },
    "eat": {
      "desc": "Moses Lake (old)",
      "geo": [ -119.28, 47.12 ],
      "service_address_ranges": [
        "192.69.96.0/23",
        "208.78.166.0/24"
      ]
    },
    "fra": {
      "desc": "Frankfurt",
      "geo": [ 8.68, 50.12 ],
      "relay_addresses": [
        "162.254.197.162:27015-27068",
        "162.254.197.163:27015-27068",
        "162.254.197.164:27015-27068",
        "162.254.197.165:27015-27068",
        "162.254.197.170:27015-27068",
        "162.254.197.171:27015-27068",
        "162.254.197.172:27015-27068",
        "162.254.197.173:27015-27068",
        "162.254.197.70:27015-27052",
        "162.254.197.71:27015-27052",
        "162.254.197.72:27015-27052",
        "162.254.197.73:27015-27052",
        "162.254.197.74:27015-27052",
        "162.254.197.75:27015-27052"
      ]
    },
    "gru": {
      "desc": "SÃ£o Paulo",
      "geo": [ -46.64, -23.53 ],
      "relay_addresses": [
        "205.185.194.34:27015-27052",
        "205.185.194.35:27015-27068",
        "205.185.194.36:27015-27068",
        "205.185.194.50:27015-27052",
        "205.185.194.51:27015-27068",
        "205.185.194.52:27015-27068"
      ],
      "service_address_ranges": [
        "155.133.224.0/23"
      ]
    },
    "hkg": {
      "desc": "Hong Kong",
      "geo": [ 113.92, 22.31 ],
      "relay_addresses": [
        "153.254.86.170:27015-27052",
        "153.254.86.171:27015-27052",
        "153.254.86.172:27015-27052"
      ],
      "service_address_ranges": [
        "155.133.244.0/24"
      ]
    },
    "iad": {
      "desc": "Sterling",
      "geo": [ -77.43, 39.01 ],
      "relay_addresses": [
        "162.254.192.66:27015-27052",
        "162.254.192.67:27015-27052",
        "162.254.192.82:27015-27052",
        "162.254.192.83:27015-27052"
      ],
      "service_address_ranges": [
        "208.78.164.0/23"
      ]
    },
    "jnb": {
      "desc": "Johannesburg",
      "geo": [ 18.42, -33.05 ],
      "relay_addresses": [
        "155.133.238.162:27015-27068",
        "155.133.238.163:27015-27068"
      ],
      "service_address_ranges": [
        "155.133.238.0/24"
      ]
    },
    "lax": {
      "desc": "Los Angeles",
      "geo": [ -118.25, 34.05 ],
      "relay_addresses": [
        "162.254.195.70:27015-27052",
        "162.254.195.71:27015-27052"
      ],
      "service_address_ranges": [
        "162.254.194.0/24"
      ]
    },
    "lhr": {
      "desc": "London",
      "geo": [ -0.13, 51.51 ],
      "relay_addresses": [
        "162.254.196.82:27015-27052",
        "162.254.196.66:27015-27052"
      ]
    },
    "lim": {
      "desc": "Lima",
      "geo": [ -77.05, -12.06 ],
      "relay_addresses": [
        "190.217.33.34:27015-27052",
        "190.217.33.50:27015-27052"
      ],
      "service_address_ranges": [
        "143.137.146.0/24",
        "190.216.121.0/24"
      ]
    },
    "lux": {
      "desc": "Luxembourg",
      "geo": [ 13.41, 52.52 ],
      "relay_addresses": [
        "146.66.154.20:27015-27052",
        "146.66.154.21:27015-27052",
        "146.66.154.22:27015-27052",
        "146.66.154.23:27015-27052"
      ],
      "service_address_ranges": [
        "146.66.152.0/23",
        "146.66.158.0/23",
        "155.133.240.0/23"
      ]
    },
    "maa": {
      "desc": "Chennai",
      "geo": [ 80.27, 13.08 ],
      "relay_addresses": [
        "155.133.232.98:27015-27060"
      ],
      "service_address_ranges": [
        "155.133.232.0/24"
      ]
    },
    "mad": {
      "desc": "Madrid",
      "geo": [ 3.34, 40.23 ],
      "relay_addresses": [
        "155.133.246.50:27015-27052",
        "155.133.246.34:27015-27052"
      ],
      "service_address_ranges": [
        "155.133.247.0/24"
      ]
    },
    "man": {
      "desc": "Manilla",
      "geo": [ 120.59, 14.35 ],
      "relay_addresses": [
        "155.133.253.3:27015-27052",
        "155.133.253.4:27015-27068",
        "155.133.253.18:27015-27052",
        "155.133.253.19:27015-27068"
      ]
    },
    "mwh": {
      "desc": "Moses Lake",
      "geo": [ -119.28, 47.12 ],
      "relay_addresses": [
        "155.133.235.9:27015-27052",
        "155.133.235.10:27015-27052"
      ]
    },
    "okc": {
      "desc": "Oklahoma City",
      "geo": [ -97.53, 35.48 ],
      "relay_addresses": [
        "155.133.254.130:27015-27068",
        "155.133.254.131:27015-27068",
        "155.133.254.138:27015-27068",
        "155.133.254.139:27015-27068",
        "155.133.254.140:27015-27068",
        "155.133.254.141:27015-27068"
      ]
    },
    "ord": {
      "desc": "Chicago",
      "geo": [ -87.69, 41.84 ],
      "relay_addresses": [
        "162.254.193.98:27015-27052",
        "162.254.193.71:27015-27052"
      ],
      "service_address_ranges": [
        "208.78.167.0/24"
      ]
    },
    "par": {
      "desc": "Paris",
      "geo": [ 2.35, 48.86 ],
      "relay_addresses": [
        "185.25.182.66:27015-27068",
        "185.25.182.67:27015-27068",
        "185.25.182.68:27015-27068",
        "185.25.182.69:27015-27068"
      ]
    },
    "pwg": {
      "geo": [ 113.3, 23.1 ],
      "partners": 2,
      "ping_only": true,
      "relay_addresses": [
        "125.88.173.11:27015-27016",
        "125.88.173.12:27015-27016",
        "125.88.173.13:27015-27016"
      ],
      "service_address_ranges": [
        "125.88.173.0/24"
      ]
    },
    "pwj": {
      "geo": [ 116.4, 38.3 ],
      "partners": 2,
      "ping_only": true,
      "relay_addresses": [
        "220.194.68.11:27015-27016",
        "220.194.68.12:27015-27016",
        "220.194.68.13:27015-27016"
      ],
      "service_address_ranges": [
        "220.194.68.0/24"
      ]
    },
    "pwt": {
      "geo": [ 121.5, 31.2 ],
      "partners": 2,
      "service_address_ranges": [
        "121.46.228.0/24",
        "221.228.192.0/24"
      ]
    },
    "pwu": {
      "geo": [ 116.4, 39.9 ],
      "partners": 2,
      "ping_only": true,
      "relay_addresses": [
        "61.182.135.15:27015-27016",
        "61.182.135.16:27015-27016",
        "61.182.135.17:27015-27016"
      ],
      "service_address_ranges": [
        "61.182.135.0/24"
      ]
    },
    "pww": {
      "geo": [ 114.2, 30.4 ],
      "partners": 2,
      "ping_only": true,
      "relay_addresses": [
        "116.211.132.11:27015-27016",
        "116.211.132.12:27015-27016",
        "116.211.132.13:27015-27016"
      ],
      "service_address_ranges": [
        "116.211.132.0/24"
      ]
    },
    "pwz": {
      "geo": [ 120.5, 29.2 ],
      "partners": 2,
      "ping_only": true,
      "relay_addresses": [
        "183.136.230.11:27015-27016",
        "183.136.230.12:27015-27016",
        "183.136.230.13:27015-27016"
      ],
      "service_address_ranges": [
        "183.136.230.0/24"
      ]
    },
    "scl": {
      "desc": "Santiago",
      "geo": [ -70.47, -33.23 ],
      "relay_addresses": [
        "155.133.249.162:27015-27052",
        "155.133.249.178:27015-27052"
      ],
      "service_address_ranges": [
        "155.133.249.0/24"
      ]
    },
    "sea": {
      "desc": "Seattle",
      "geo": [ -122.33, 47.61 ],
      "relay_addresses": [
        "205.196.6.134:27015-27052",
        "205.196.6.135:27015-27052"
      ]
    },
    "sgp": {
      "desc": "Singapore",
      "geo": [ 103.83, 1.28 ],
      "relay_addresses": [
        "103.10.124.40:27015-27052",
        "103.10.124.43:27015-27052",
        "103.10.124.44:27015-27052",
        "103.10.124.45:27015-27052",
        "103.10.124.99:27015-27052",
        "103.10.124.100:27015-27052",
        "103.10.124.101:27015-27052",
        "103.10.124.102:27015-27052"
      ],
      "service_address_ranges": [
        "45.121.184.0/23",
        "103.28.54.0/23"
      ]
    },
    "sha": {
      "desc": "Shanghai",
      "geo": [ 121.5, 31.2 ],
      "partners": 2,
      "relay_addresses": [
        "121.46.228.11:27015-27068",
        "121.46.228.12:27015-27068",
        "121.46.228.13:27015-27068",
        "121.46.228.14:27015-27068"
      ],
      "service_address_ranges": [
        "121.46.225.0/24",
        "218.78.184.0/24"
      ]
    },
    "sham": {
      "partners": 2,
      "relay_addresses": [
        "117.184.42.132:27015-27068",
        "117.184.42.133:27015-27068",
        "117.184.42.134:27015-27068",
        "117.184.42.135:27015-27068",
        "117.184.42.136:27015-27068",
        "117.184.42.137:27015-27068"
      ]
    },
    "shat": {
      "partners": 2,
      "relay_addresses": [
        "121.46.225.11:27015-27068",
        "121.46.225.12:27015-27068",
        "121.46.225.13:27015-27068",
        "121.46.225.14:27015-27068",
        "121.46.225.15:27015-27068",
        "121.46.225.16:27015-27068"
      ]
    },
    "shau": {
      "partners": 2,
      "relay_addresses": [
        "43.240.125.134:27015-27068",
        "43.240.125.135:27015-27068",
        "43.240.125.136:27015-27068",
        "43.240.125.137:27015-27068",
        "43.240.125.138:27015-27068",
        "43.240.125.139:27015-27068"
      ]
    },
    "sto": {
      "desc": "Stockholm (Kista)",
      "geo": [ 17.90, 59.40 ],
      "relay_addresses": [
        "162.254.198.40:27015-27052",
        "162.254.198.41:27015-27052",
        "162.254.198.42:27015-27052",
        "162.254.198.43:27015-27052",
        "162.254.198.100:27015-27052",
        "162.254.198.101:27015-27052",
        "162.254.198.102:27015-27052",
        "162.254.198.103:27015-27052"
      ],
      "service_address_ranges": [
        "146.66.156.0/23",
        "155.133.242.0/23",
        "185.25.180.0/23"
      ]
    },
    "sto2": {
      "desc": "Stockholm (Bromma)",
      "geo": [ 17.87, 59.34 ],
      "relay_addresses": [
        "155.133.252.34:27015-27068",
        "155.133.252.35:27015-27068",
        "155.133.252.50:27015-27068",
        "155.133.252.51:27015-27068",
        "155.133.252.66:27015-27068",
        "155.133.252.67:27015-27068",
        "155.133.252.68:27015-27068",
        "155.133.252.69:27015-27068"
      ]
    },
    "syd": {
      "desc": "Sydney",
      "geo": [ 151.21, 33.86 ],
      "relay_addresses": [
        "103.10.125.146:27015-27068",
        "103.10.125.154:27015-27068"
      ],
      "service_address_ranges": [
        "155.133.227.0/24"
      ]
    },
    "tsn": {
      "geo": [ 117.1, 39.8 ],
      "partners": 2,
      "service_address_ranges": [
        "125.39.181.0-125.39.181.127"
      ]
    },
    "tsnm": {
      "partners": 2,
      "relay_addresses": [
        "117.131.203.17:27015-27068",
        "117.131.203.18:27015-27068",
        "117.131.203.19:27015-27068",
        "117.131.203.20:27015-27068",
        "117.131.203.21:27015-27068",
        "117.131.203.22:27015-27068"
      ]
    },
    "tsnt": {
      "partners": 2,
      "relay_addresses": [
        "119.90.27.14:27015-27068",
        "119.90.27.15:27015-27068",
        "119.90.27.16:27015-27068",
        "119.90.27.17:27015-27068",
        "119.90.27.18:27015-27068",
        "119.90.27.19:27015-27068"
      ]
    },
    "tsnu": {
      "partners": 2,
      "relay_addresses": [
        "125.39.181.11:27015-27068",
        "125.39.181.12:27015-27068",
        "125.39.181.13:27015-27068",
        "125.39.181.14:27015-27068",
        "125.39.181.15:27015-27068",
        "125.39.181.16:27015-27068"
      ]
    },
    "tuk": {
      "desc": "Tukwila",
      "geo": [ -122.28, 47.48 ],
      "relay_addresses": [
        "208.64.200.252:27015-27052"
      ]
    },
    "tyo": {
      "desc": "Tokyo",
      "geo": [ 139.68, 35.68 ],
      "relay_addresses": [
        "155.133.239.25:27015-27052",
        "155.133.239.26:27015-27052",
        "155.133.239.59:27015-27052"
      ],
      "service_address_ranges": [
        "45.121.186.0/23"
      ]
    },
    "vie": {
      "desc": "Vienna",
      "geo": [ 16.22, 48.12 ],
      "relay_addresses": [
        "146.66.155.34:27015-27068",
        "146.66.155.35:27015-27068",
        "146.66.155.36:27015-27068",
        "146.66.155.37:27015-27052",
        "146.66.155.50:27015-27068",
        "146.66.155.51:27015-27068",
        "146.66.155.52:27015-27068",
        "146.66.155.53:27015-27052"
      ],
      "service_address_ranges": [
        "146.66.155.0/24",
        "155.133.228.0/23",
        "185.25.182.0/24"
      ]
    },
    "waw": {
      "desc": "Warsaw",
      "geo": [ 21.0, 52.22 ],
      "relay_addresses": [
        "155.133.230.35:27015-27068",
        "155.133.230.36:27015-27068",
        "155.133.230.51:27015-27068",
        "155.133.230.52:27015-27068"
      ],
      "service_address_ranges": [
        "155.133.231.0/24"
      ]
    }
  }
}
`
